// TrackList - Reorderable list of tracks for final output.
// Clean compact layout.

import { VerticalBox, HorizontalBox, ScrollView, Button } from "std-widgets.slint";
import { TrackWidget, TrackWidgetData } from "track_widget.slint";

// Final track data
export struct FinalTrackData {
    track: TrackWidgetData,
    position: int,
    sync-source-options: [string],
}

// Single entry
component TrackListEntry inherits Rectangle {
    in property <FinalTrackData> data;
    in property <bool> show-move-buttons: true;
    in property <bool> is-first: false;
    in property <bool> is-last: false;

    callback move-up();
    callback move-down();
    callback remove();
    callback default-changed(bool);
    callback forced-changed(bool);
    callback name-changed(bool);
    callback sync-source-changed(string);
    callback settings-clicked();
    callback style-editor-clicked();

    background: #333333;
    border-radius: 4px;
    min-height: 56px;

    HorizontalBox {
        padding: 4px;
        spacing: 4px;

        // Move controls
        if root.show-move-buttons: VerticalBox {
            alignment: center;
            spacing: 2px;
            padding: 2px;

            Button {
                text: "^";
                enabled: !root.is-first;
                max-width: 24px;
                clicked => { root.move-up(); }
            }

            Text {
                text: data.position + 1;
                font-size: 10px;
                color: #666666;
                horizontal-alignment: center;
            }

            Button {
                text: "v";
                enabled: !root.is-last;
                max-width: 24px;
                clicked => { root.move-down(); }
            }
        }

        // Track type bar
        Rectangle {
            width: 3px;
            border-radius: 1px;
            background: data.track.track-type == "video" ? #8855dd :
                        data.track.track-type == "audio" ? #55aa55 : #ddaa55;
        }

        // Track widget
        TrackWidget {
            horizontal-stretch: 1;
            data: data.track;
            sync-source-options: data.sync-source-options;

            default-changed(val) => { root.default-changed(val); }
            forced-changed(val) => { root.forced-changed(val); }
            name-changed(val) => { root.name-changed(val); }
            sync-source-changed(src) => { root.sync-source-changed(src); }
            settings-clicked => { root.settings-clicked(); }
            style-editor-clicked => { root.style-editor-clicked(); }
        }

        // Remove button
        Button {
            text: "X";
            max-width: 28px;
            clicked => { root.remove(); }
        }
    }
}

export component TrackList inherits Rectangle {
    in property <[FinalTrackData]> tracks: [];
    in property <bool> reorderable: true;

    callback track-moved(int, int);
    callback track-removed(int);
    callback default-changed(int, bool);
    callback forced-changed(int, bool);
    callback name-changed(int, bool);
    callback sync-source-changed(int, string);
    callback settings-clicked(int);
    callback style-editor-clicked(int);

    background: #2a2a2a;
    border-radius: 4px;

    VerticalBox {
        padding: 0px;

        if tracks.length == 0: Rectangle {
            vertical-stretch: 1;

            VerticalBox {
                alignment: center;

                Text {
                    text: "No tracks selected";
                    font-size: 13px;
                    color: #666666;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Double-click tracks on the left to add";
                    font-size: 11px;
                    color: #555555;
                    horizontal-alignment: center;
                }
            }
        }

        if tracks.length > 0: ScrollView {
            vertical-stretch: 1;

            VerticalBox {
                padding: 4px;
                spacing: 4px;

                for item[idx] in tracks: TrackListEntry {
                    data: item;
                    show-move-buttons: root.reorderable;
                    is-first: idx == 0;
                    is-last: idx == tracks.length - 1;

                    move-up => { root.track-moved(idx, idx - 1); }
                    move-down => { root.track-moved(idx, idx + 1); }
                    remove => { root.track-removed(idx); }
                    default-changed(val) => { root.default-changed(idx, val); }
                    forced-changed(val) => { root.forced-changed(idx, val); }
                    name-changed(val) => { root.name-changed(idx, val); }
                    sync-source-changed(src) => { root.sync-source-changed(idx, src); }
                    settings-clicked => { root.settings-clicked(idx); }
                    style-editor-clicked => { root.style-editor-clicked(idx); }
                }
            }
        }
    }
}
