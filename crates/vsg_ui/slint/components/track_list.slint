// TrackList - Reorderable list of tracks for final output.
// Dense Qt-style flat rows - NOT card UI.

import { VerticalBox, HorizontalBox, ScrollView, Button } from "std-widgets.slint";
import { TrackWidget, TrackWidgetData } from "track_widget.slint";

// Final track data
export struct FinalTrackData {
    track: TrackWidgetData,
    position: int,
    sync-source-options: [string],
}

// Single entry - flat Qt-style row (~42px)
component TrackListEntry inherits Rectangle {
    in property <FinalTrackData> data;
    in property <bool> show-move-buttons: true;
    in property <bool> is-first: false;
    in property <bool> is-last: false;

    callback move-up();
    callback move-down();
    callback remove();
    callback default-changed(bool);
    callback forced-changed(bool);
    callback name-changed(bool);
    callback sync-source-changed(string);
    callback settings-clicked();
    callback style-editor-clicked();
    callback context-menu-requested();

    // Flat style - no rounded corners, transparent bg, hover highlight only
    background: touch.has-hover ? #2d3236 : transparent;
    border-radius: 0px;
    height: 42px;

    touch := TouchArea {
        pointer-event(event) => {
            if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                root.context-menu-requested();
            }
        }
    }

    HorizontalLayout {
        padding-left: 2px;
        padding-right: 2px;
        spacing: 2px;

        // Track type bar
        Rectangle {
            width: 3px;
            background: data.track.track-type == "video" ? #8855dd :
                        data.track.track-type == "audio" ? #55aa55 : #ddaa55;
        }

        // Track widget
        TrackWidget {
            horizontal-stretch: 1;
            data: data.track;
            sync-source-options: data.sync-source-options;

            default-changed(val) => { root.default-changed(val); }
            forced-changed(val) => { root.forced-changed(val); }
            name-changed(val) => { root.name-changed(val); }
            sync-source-changed(src) => { root.sync-source-changed(src); }
            settings-clicked => { root.settings-clicked(); }
            style-editor-clicked => { root.style-editor-clicked(); }
        }

        // Remove button - visible only on hover
        if touch.has-hover: Button {
            text: "Ã—";
            width: 20px;
            height: 20px;
            clicked => { root.remove(); }
        }
    }

    // Bottom border separator
    Rectangle {
        y: parent.height - 1px;
        height: 1px;
        background: #3a3a3a;
    }
}

export component TrackList inherits Rectangle {
    in property <[FinalTrackData]> tracks: [];
    in property <bool> reorderable: true;

    callback track-moved(int, int);
    callback track-removed(int);
    callback default-changed(int, bool);
    callback forced-changed(int, bool);
    callback name-changed(int, bool);
    callback sync-source-changed(int, string);
    callback settings-clicked(int);
    callback style-editor-clicked(int);

    // Flat style - no rounded corners
    background: transparent;

    VerticalLayout {
        padding: 0px;
        spacing: 0px;

        if tracks.length == 0: Rectangle {
            vertical-stretch: 1;

            VerticalLayout {
                alignment: center;
                spacing: 2px;

                Text {
                    text: "No tracks selected";
                    font-size: 11px;
                    color: #666666;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Double-click tracks on the left to add";
                    font-size: 10px;
                    color: #555555;
                    horizontal-alignment: center;
                }
            }
        }

        if tracks.length > 0: ScrollView {
            vertical-stretch: 1;

            VerticalLayout {
                padding: 0px;
                spacing: 0px;

                for item[idx] in tracks: TrackListEntry {
                    data: item;
                    show-move-buttons: root.reorderable;
                    is-first: idx == 0;
                    is-last: idx == tracks.length - 1;

                    move-up => { root.track-moved(idx, idx - 1); }
                    move-down => { root.track-moved(idx, idx + 1); }
                    remove => { root.track-removed(idx); }
                    default-changed(val) => { root.default-changed(idx, val); }
                    forced-changed(val) => { root.forced-changed(idx, val); }
                    name-changed(val) => { root.name-changed(idx, val); }
                    sync-source-changed(src) => { root.sync-source-changed(idx, src); }
                    settings-clicked => { root.settings-clicked(idx); }
                    style-editor-clicked => { root.style-editor-clicked(idx); }
                }
            }
        }
    }
}
