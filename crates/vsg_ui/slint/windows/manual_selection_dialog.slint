// ManualSelectionDialog - Track configuration dialog.
// Left pane: Source tracks. Right pane: Final output + attachments.
// Dense Qt-style layout - NOT modern card UI.

import { VerticalBox, HorizontalBox, Button, ScrollView, GroupBox, CheckBox } from "std-widgets.slint";
import { SourceGroup } from "../components/source_group.slint";
import { TrackList, FinalTrackData } from "../components/track_list.slint";
import { TrackWidgetData } from "../components/track_widget.slint";

// Source group data
export struct SourceGroupData {
    source-key: string,
    title: string,
    tracks: [TrackWidgetData],
    blocked: [bool],
}

// Attachment option
export struct AttachmentSourceOption {
    source-key: string,
    label: string,
    checked: bool,
}

export component ManualSelectionDialog inherits Window {
    title: "Manual Track Selection";
    min-width: 1200px;
    min-height: 700px;
    default-font-size: 12px;

    in-out property <[SourceGroupData]> source-groups: [];
    in-out property <[FinalTrackData]> final-tracks: [];
    in-out property <[TrackWidgetData]> external-tracks: [];
    in-out property <bool> show-external-group: false;
    in-out property <[AttachmentSourceOption]> attachment-options: [];
    in-out property <string> info-message: "";
    in-out property <bool> show-info: false;
    in-out property <bool> has-style-clipboard: false;

    // Source list callbacks
    callback source-track-double-clicked(int, string);
    callback source-track-context-menu(int, string);
    callback external-track-double-clicked(int);
    callback configure-source-correlation(string);
    callback add-external-subtitles();

    // Final list callbacks
    callback final-track-moved(int, int);
    callback final-track-removed(int);
    callback final-track-default-changed(int, bool);
    callback final-track-forced-changed(int, bool);
    callback final-track-name-changed(int, bool);
    callback final-track-sync-changed(int, string);
    callback final-track-settings-clicked(int);
    callback final-track-style-editor-clicked(int);

    // Attachment callbacks
    callback attachment-toggled(string, bool);

    // Dialog callbacks
    callback accept();
    callback cancel();

    VerticalLayout {
        padding: 4px;
        spacing: 4px;

        // Info message
        if root.show-info && info-message != "": Text {
            text: info-message;
            color: #55aa55;
            font-size: 11px;
            font-weight: 600;
        }

        // Main content - two panes (35% / 65%)
        HorizontalLayout {
            vertical-stretch: 1;
            spacing: 4px;

            // Left pane - Source tracks (35%)
            VerticalLayout {
                width: parent.width * 35%;

                // Header
                Text {
                    text: "Available Tracks";
                    font-weight: 600;
                    color: #d0d0d0;
                    font-size: 12px;
                }
                Rectangle { height: 1px; background: #3a3a3a; }

                ScrollView {
                    vertical-stretch: 1;

                    VerticalLayout {
                        padding: 0px;
                        spacing: 2px;

                        for group in source-groups: SourceGroup {
                            title: group.title;
                            source-key: group.source-key;
                            tracks: group.tracks;
                            blocked-tracks: group.blocked;

                            track-double-clicked(id) => {
                                root.source-track-double-clicked(id, group.source-key);
                            }
                            track-context-menu(id) => {
                                root.source-track-context-menu(id, group.source-key);
                            }
                            configure-correlation => {
                                root.configure-source-correlation(group.source-key);
                            }
                        }

                        if root.show-external-group: SourceGroup {
                            title: "External Subtitles";
                            source-key: "External";
                            tracks: external-tracks;
                            blocked-tracks: [];
                            show-configure-button: false;

                            track-double-clicked(id) => {
                                root.external-track-double-clicked(id);
                            }
                        }

                        Rectangle { vertical-stretch: 1; }
                    }
                }

                Button {
                    text: "+ Add External Subtitle(s)...";
                    height: 24px;
                    clicked => { root.add-external-subtitles(); }
                }
            }

            // Right pane - Final output and attachments (65%)
            VerticalLayout {
                horizontal-stretch: 1;
                spacing: 2px;

                // Header
                Text {
                    text: "Final Output (Drag to reorder)";
                    font-weight: 600;
                    color: #d0d0d0;
                    font-size: 12px;
                }
                Rectangle { height: 1px; background: #3a3a3a; }

                TrackList {
                    vertical-stretch: 1;
                    tracks: final-tracks;
                    reorderable: true;

                    track-moved(from, to) => { root.final-track-moved(from, to); }
                    track-removed(idx) => { root.final-track-removed(idx); }
                    default-changed(idx, val) => { root.final-track-default-changed(idx, val); }
                    forced-changed(idx, val) => { root.final-track-forced-changed(idx, val); }
                    name-changed(idx, val) => { root.final-track-name-changed(idx, val); }
                    sync-source-changed(idx, src) => { root.final-track-sync-changed(idx, src); }
                    settings-clicked(idx) => { root.final-track-settings-clicked(idx); }
                    style-editor-clicked(idx) => { root.final-track-style-editor-clicked(idx); }
                }

                // Attachments row
                Rectangle {
                    height: 28px;
                    background: #2a2a2a;

                    HorizontalLayout {
                        spacing: 8px;
                        padding: 4px;

                        Text {
                            text: "Include attachments from:";
                            font-weight: 600;
                            vertical-alignment: center;
                        }

                        for opt in attachment-options: CheckBox {
                            text: opt.label;
                            checked: opt.checked;
                            toggled => { root.attachment-toggled(opt.source-key, self.checked); }
                        }

                        Rectangle { horizontal-stretch: 1; }
                    }
                }
            }
        }

        // Dialog buttons
        HorizontalLayout {
            alignment: end;
            spacing: 4px;

            Button {
                text: "Cancel";
                height: 24px;
                clicked => { root.cancel(); }
            }

            Button {
                text: "OK";
                height: 24px;
                clicked => { root.accept(); }
            }
        }
    }
}
