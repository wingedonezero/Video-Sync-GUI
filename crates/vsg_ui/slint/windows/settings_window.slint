import { VerticalBox, HorizontalBox, Button, LineEdit, GroupBox, CheckBox, SpinBox, ComboBox, TabWidget, ScrollView } from "std-widgets.slint";

// Row with label and tooltip icon
component LabelWithTip inherits HorizontalLayout {
    in property <string> label;
    in property <string> tooltip;

    spacing: 4px;

    Text {
        text: root.label;
        vertical-alignment: center;
        min-width: 140px;
    }

    if root.tooltip != "": Rectangle {
        width: 16px;
        height: 16px;
        background: #666666;
        border-radius: 8px;

        Text {
            text: "?";
            color: white;
            font-size: 10px;
            horizontal-alignment: center;
            vertical-alignment: center;
        }

        tip-area := TouchArea {}

        Rectangle {
            x: tip-area.mouse-x + 12px;
            y: tip-area.mouse-y + 12px;
            width: tip-label.preferred-width + 16px;
            height: tip-label.preferred-height + 12px;
            background: #2a2a2a;
            border-radius: 4px;
            opacity: 0;

            states [
                visible when tip-area.has-hover: {
                    opacity: 0.98;
                    in { animate opacity { duration: 150ms; delay: 400ms; } }
                    out { animate opacity { duration: 100ms; } }
                }
            ]

            tip-label := Text {
                x: 8px;
                y: 6px;
                text: root.tooltip;
                color: #eeeeee;
                font-size: 11px;
                wrap: word-wrap;
                max-width: 280px;
            }
        }
    }
}

export component SettingsWindow inherits Window {
    title: "Settings";
    min-width: 750px;
    min-height: 500px;
    preferred-width: 800px;
    preferred-height: 550px;
    default-font-size: 13px;

    // Storage settings
    in-out property <string> output-folder: "sync_output";
    in-out property <string> temp-root: ".temp";
    in-out property <string> logs-folder: ".logs";

    // Logging settings
    in-out property <bool> compact-logging: true;
    in-out property <bool> autoscroll: true;
    in-out property <int> error-tail: 20;
    in-out property <int> progress-step: 20;
    in-out property <bool> show-options-pretty: false;
    in-out property <bool> show-options-json: false;

    // Analysis settings
    in-out property <int> analysis-mode-index: 0;  // 0 = Audio, 1 = Video
    in-out property <int> correlation-method-index: 0;  // 0 = SCC, 1 = GCC-PHAT, 2 = GCC-SCOT, 3 = Whitened
    in-out property <string> lang-source1: "";
    in-out property <string> lang-others: "";
    in-out property <int> chunk-count: 10;
    in-out property <int> chunk-duration: 15;
    in-out property <float> min-match-pct: 5.0;
    in-out property <float> scan-start-pct: 5.0;
    in-out property <float> scan-end-pct: 95.0;
    in-out property <int> filtering-method-index: 0;  // 0 = None, 1 = Low Pass, 2 = Band Pass, 3 = High Pass
    in-out property <int> filter-low-cutoff-hz: 300;
    in-out property <int> filter-high-cutoff-hz: 3400;
    in-out property <bool> use-soxr: true;
    in-out property <bool> audio-peak-fit: true;
    in-out property <bool> multi-correlation-enabled: false;
    // Multi-correlation method selection
    in-out property <bool> multi-corr-scc: true;
    in-out property <bool> multi-corr-gcc-phat: true;
    in-out property <bool> multi-corr-gcc-scot: true;
    in-out property <bool> multi-corr-whitened: true;

    // Delay selection settings
    in-out property <int> delay-selection-mode-index: 0;  // 0 = Mode, 1 = Mode Clustered, 2 = Mode Early, 3 = First Stable, 4 = Average
    in-out property <int> min-accepted-chunks: 3;
    in-out property <int> first-stable-min-chunks: 3;
    in-out property <bool> first-stable-skip-unstable: true;
    in-out property <int> early-cluster-window: 10;
    in-out property <int> early-cluster-threshold: 3;

    // Chapter settings
    in-out property <bool> chapter-rename: false;
    in-out property <bool> chapter-snap: false;
    in-out property <int> snap-mode-index: 0;  // 0 = Previous, 1 = Nearest
    in-out property <int> snap-threshold-ms: 250;
    in-out property <bool> snap-starts-only: true;

    // Post-process settings
    in-out property <bool> disable-track-stats: false;
    in-out property <bool> disable-header-compression: true;
    in-out property <bool> apply-dialog-norm: false;

    // Callbacks
    callback save-clicked();
    callback cancel-clicked();
    callback browse-output();
    callback browse-temp();
    callback browse-logs();

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        TabWidget {
            Tab {
                title: "Storage";

                VerticalBox {
                    padding: 16px;
                    spacing: 12px;

                    GroupBox {
                        title: "Paths";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Output Directory:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                LineEdit {
                                    text <=> output-folder;
                                    horizontal-stretch: 1;
                                }
                                Button {
                                    text: "Browse";
                                    clicked => { browse-output(); }
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Temporary Directory:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                LineEdit {
                                    text <=> temp-root;
                                    horizontal-stretch: 1;
                                }
                                Button {
                                    text: "Browse";
                                    clicked => { browse-temp(); }
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Logs Directory:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                LineEdit {
                                    text <=> logs-folder;
                                    horizontal-stretch: 1;
                                }
                                Button {
                                    text: "Browse";
                                    clicked => { browse-logs(); }
                                }
                            }
                        }
                    }

                    // Spacer
                    Rectangle { vertical-stretch: 1; }
                }
            }

            Tab {
                title: "Analysis";

                ScrollView {
                    VerticalBox {
                        padding: 16px;
                        spacing: 12px;

                        GroupBox {
                            title: "Core Settings";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            HorizontalLayout {
                                spacing: 8px;
                                LabelWithTip {
                                    label: "Analysis Mode:";
                                    tooltip: "Audio Correlation analyzes audio waveforms to find sync offset. Video Diff compares video frames (slower but works when audio differs).";
                                }
                                ComboBox {
                                    model: ["Audio Correlation", "Video Diff"];
                                    current-index <=> analysis-mode-index;
                                    horizontal-stretch: 1;
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                LabelWithTip {
                                    label: "Correlation Method:";
                                    tooltip: "SCC: Standard cross-correlation, good general purpose.\nGCC-PHAT: Phase-based, robust to volume differences.\nGCC-SCOT: Better when one source has more noise.\nWhitened: Robust to spectral/EQ differences.";
                                }
                                ComboBox {
                                    model: ["Standard (SCC)", "Phase (GCC-PHAT)", "GCC-SCOT", "Whitened"];
                                    current-index <=> correlation-method-index;
                                    horizontal-stretch: 1;
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                LabelWithTip {
                                    label: "Number of Chunks:";
                                    tooltip: "How many audio segments to analyze. More chunks = more reliable but slower. 10 is usually sufficient.";
                                }
                                SpinBox {
                                    value <=> chunk-count;
                                    minimum: 1;
                                    maximum: 100;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                LabelWithTip {
                                    label: "Chunk Duration (sec):";
                                    tooltip: "Length of each audio segment in seconds. Longer chunks are more accurate but use more memory. 15s is a good default.";
                                }
                                SpinBox {
                                    value <=> chunk-duration;
                                    minimum: 5;
                                    maximum: 60;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                LabelWithTip {
                                    label: "Min Match %:";
                                    tooltip: "Minimum correlation confidence required to accept a chunk result. Lower values accept more results but may include false matches.";
                                }
                                SpinBox {
                                    value: round(min-match-pct);
                                    minimum: 1;
                                    maximum: 100;
                                    edited(v) => { min-match-pct = v; }
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                        }
                    }

                    GroupBox {
                        title: "Audio Track Selection";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Source 1 Language:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                LineEdit {
                                    text <=> lang-source1;
                                    placeholder-text: "e.g., jpn (leave empty for any)";
                                    horizontal-stretch: 1;
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Other Sources Lang:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                LineEdit {
                                    text <=> lang-others;
                                    placeholder-text: "e.g., eng (leave empty for any)";
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                    }

                    GroupBox {
                        title: "Scan Range";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Scan Start %:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value: round(scan-start-pct);
                                    minimum: 0;
                                    maximum: 50;
                                    edited(v) => { scan-start-pct = v; }
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Scan End %:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value: round(scan-end-pct);
                                    minimum: 50;
                                    maximum: 100;
                                    edited(v) => { scan-end-pct = v; }
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                        }
                    }

                    GroupBox {
                        title: "Audio Preparation";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Audio Filtering:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                ComboBox {
                                    model: ["None", "Low-Pass Filter", "Band-Pass Filter", "High-Pass Filter"];
                                    current-index <=> filtering-method-index;
                                    horizontal-stretch: 1;
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Low Cutoff (Hz):";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> filter-low-cutoff-hz;
                                    minimum: 20;
                                    maximum: 8000;
                                    enabled: filtering-method-index == 2 || filtering-method-index == 3;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "High Cutoff (Hz):";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> filter-high-cutoff-hz;
                                    minimum: 100;
                                    maximum: 20000;
                                    enabled: filtering-method-index == 1 || filtering-method-index == 2;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                        }
                    }

                    GroupBox {
                        title: "Delay Selection";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Selection Mode:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                ComboBox {
                                    model: ["Mode (Most Common)", "Mode (Clustered)", "Mode (Early Cluster)", "First Stable", "Average"];
                                    current-index <=> delay-selection-mode-index;
                                    horizontal-stretch: 1;
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Min Accepted Chunks:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> min-accepted-chunks;
                                    minimum: 1;
                                    maximum: 50;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "First Stable Min:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> first-stable-min-chunks;
                                    minimum: 2;
                                    maximum: 20;
                                    enabled: delay-selection-mode-index == 3;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            CheckBox {
                                text: "First Stable: Skip unstable chunks before selection";
                                checked <=> first-stable-skip-unstable;
                                enabled: delay-selection-mode-index == 3;
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Early Cluster Window:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> early-cluster-window;
                                    minimum: 3;
                                    maximum: 50;
                                    enabled: delay-selection-mode-index == 2;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Early Cluster Threshold:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> early-cluster-threshold;
                                    minimum: 2;
                                    maximum: 20;
                                    enabled: delay-selection-mode-index == 2;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                        }
                    }

                    GroupBox {
                        title: "Advanced";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            CheckBox {
                                text: "Use High-Quality Resampling (SoXR)";
                                checked <=> use-soxr;
                            }

                            CheckBox {
                                text: "Enable Sub-Sample Peak Fitting";
                                checked <=> audio-peak-fit;
                            }

                            CheckBox {
                                text: "Multi-Correlation Comparison (Analyze Only)";
                                checked <=> multi-correlation-enabled;
                            }

                            // Method selection (shown when multi-correlation is enabled)
                            if multi-correlation-enabled: VerticalBox {
                                padding-left: 24px;
                                spacing: 4px;

                                Text {
                                    text: "Methods to compare:";
                                    font-size: 11px;
                                    color: #888888;
                                }

                                HorizontalLayout {
                                    spacing: 16px;

                                    CheckBox {
                                        text: "SCC";
                                        checked <=> multi-corr-scc;
                                    }

                                    CheckBox {
                                        text: "GCC-PHAT";
                                        checked <=> multi-corr-gcc-phat;
                                    }

                                    CheckBox {
                                        text: "GCC-SCOT";
                                        checked <=> multi-corr-gcc-scot;
                                    }

                                    CheckBox {
                                        text: "Whitened";
                                        checked <=> multi-corr-whitened;
                                    }
                                }
                            }
                        }
                    }

                        // Spacer
                        Rectangle { vertical-stretch: 1; }
                    }
                }
            }

            Tab {
                title: "Chapters";

                VerticalBox {
                    padding: 16px;
                    spacing: 12px;

                    GroupBox {
                        title: "Chapter Processing";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            CheckBox {
                                text: "Rename chapters to standard format (Chapter NN)";
                                checked <=> chapter-rename;
                            }

                            CheckBox {
                                text: "Snap chapter timestamps to nearest keyframe";
                                checked <=> chapter-snap;
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Snap Mode:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                ComboBox {
                                    model: ["Previous Keyframe", "Nearest Keyframe"];
                                    current-index <=> snap-mode-index;
                                    enabled: chapter-snap;
                                    horizontal-stretch: 1;
                                }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Snap Threshold (ms):";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> snap-threshold-ms;
                                    minimum: 50;
                                    maximum: 1000;
                                    enabled: chapter-snap;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            CheckBox {
                                text: "Only snap chapter start times (not ends)";
                                checked <=> snap-starts-only;
                                enabled: chapter-snap;
                            }
                        }
                    }

                    // Spacer
                    Rectangle { vertical-stretch: 1; }
                }
            }

            Tab {
                title: "Merge Behavior";

                VerticalBox {
                    padding: 16px;
                    spacing: 12px;

                    GroupBox {
                        title: "Track Options";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            CheckBox {
                                text: "Remove dialog normalization gain (AC3/E-AC3)";
                                checked <=> apply-dialog-norm;
                            }

                            CheckBox {
                                text: "Disable track statistics tags";
                                checked <=> disable-track-stats;
                            }

                            CheckBox {
                                text: "Disable header removal compression";
                                checked <=> disable-header-compression;
                            }
                        }
                    }

                    // Spacer
                    Rectangle { vertical-stretch: 1; }
                }
            }

            Tab {
                title: "Logging";

                VerticalBox {
                    padding: 16px;
                    spacing: 12px;

                    GroupBox {
                        title: "Log Output";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            CheckBox {
                                text: "Use compact logging";
                                checked <=> compact-logging;
                            }

                            CheckBox {
                                text: "Auto-scroll log view during jobs";
                                checked <=> autoscroll;
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Progress Step %:";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> progress-step;
                                    minimum: 1;
                                    maximum: 50;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }

                            HorizontalLayout {
                                spacing: 8px;
                                Text {
                                    text: "Error Tail (lines):";
                                    vertical-alignment: center;
                                    min-width: 140px;
                                }
                                SpinBox {
                                    value <=> error-tail;
                                    minimum: 5;
                                    maximum: 200;
                                    max-width: 100px;
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                        }
                    }

                    GroupBox {
                        title: "mkvmerge Options Display";

                        VerticalBox {
                            padding: 12px;
                            spacing: 8px;

                            CheckBox {
                                text: "Show mkvmerge options (pretty format)";
                                checked <=> show-options-pretty;
                            }

                            CheckBox {
                                text: "Show mkvmerge options (raw JSON)";
                                checked <=> show-options-json;
                            }
                        }
                    }

                    // Spacer
                    Rectangle { vertical-stretch: 1; }
                }
            }
        }

        // Bottom buttons
        HorizontalLayout {
            alignment: end;
            spacing: 8px;

            Button {
                text: "Cancel";
                clicked => { cancel-clicked(); }
            }

            Button {
                text: "Save";
                clicked => { save-clicked(); }
            }
        }
    }
}
