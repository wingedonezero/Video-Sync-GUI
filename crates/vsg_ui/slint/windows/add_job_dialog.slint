// AddJobDialog - Dialog for adding source files and discovering jobs.
// Clean compact layout matching Qt original.

import { VerticalBox, HorizontalBox, Button, ScrollView, LineEdit } from "std-widgets.slint";

// Data for a single source input
export struct SourceInputData {
    index: int,
    path: string,
    is-reference: bool,
}

// Source input row - matches Qt SourceInputWidget layout
component SourceInputRow inherits Rectangle {
    in property <int> index;
    in-out property <string> path;
    in property <bool> is-reference;

    callback browse-clicked();
    callback path-changed(string);

    height: 28px;

    HorizontalLayout {
        spacing: 6px;
        padding-left: 4px;
        padding-right: 4px;

        // Label (compact width)
        Text {
            text: is-reference ? "Source " + index + " (Reference):" : "Source " + index + ":";
            vertical-alignment: center;
            min-width: 120px;
        }

        // Path input with drop support (stretches to fill)
        DropArea {
            horizontal-stretch: 1;

            dropped(event) => {
                if (event.mime-type == "text/uri-list") {
                    root.path = event.data;
                    root.path-changed(event.data);
                }
            }

            LineEdit {
                text <=> root.path;
                placeholder-text: "";
                edited => { root.path-changed(root.path); }
            }
        }

        // Browse button
        Button {
            text: "Browse...";
            clicked => { root.browse-clicked(); }
        }
    }
}

export component AddJobDialog inherits Window {
    title: "Add Job(s) to Queue";
    min-width: 700px;
    min-height: 300px;
    default-font-size: 14px;

    in-out property <[SourceInputData]> sources: [
        { index: 1, path: "", is-reference: true },
        { index: 2, path: "", is-reference: false },
    ];
    in-out property <string> error-message: "";
    in-out property <bool> is-processing: false;
    out property <bool> accepted: false;

    callback add-source();
    callback browse-source(int);
    callback source-path-changed(int, string);
    callback find-and-add-jobs();
    callback cancel();

    VerticalBox {
        padding: 8px;
        spacing: 6px;

        // Source inputs
        ScrollView {
            vertical-stretch: 1;

            VerticalBox {
                spacing: 4px;

                for source[idx] in sources: SourceInputRow {
                    index: source.index;
                    path: source.path;
                    is-reference: source.is-reference;
                    browse-clicked => { root.browse-source(source.index); }
                    path-changed(p) => { root.source-path-changed(source.index, p); }
                }
            }
        }

        // Add source button
        Button {
            text: "Add Another Source";
            enabled: sources.length < 10;
            clicked => { root.add-source(); }
        }

        // Error message
        if error-message != "": Text {
            text: error-message;
            color: #ff6666;
            font-size: 12px;
        }

        // Dialog buttons (right-aligned)
        HorizontalBox {
            alignment: end;
            spacing: 6px;

            Button {
                text: is-processing ? "Discovering..." : "Find & Add Jobs";
                enabled: !is-processing;
                clicked => { root.find-and-add-jobs(); }
            }

            Button {
                text: "Cancel";
                enabled: !is-processing;
                clicked => { root.cancel(); }
            }
        }
    }
}
