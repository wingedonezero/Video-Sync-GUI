// AddJobDialog - Dialog for adding source files and discovering jobs.
// Matches the original Qt layout: clean source list with browse buttons.

import { VerticalBox, HorizontalBox, Button, ScrollView, LineEdit } from "std-widgets.slint";
import { Theme } from "../theme.slint";

// Data for a single source input
export struct SourceInputData {
    index: int,
    path: string,
    is-reference: bool,  // true for Source 1
}

// Source input row - matches Qt SourceInputWidget layout (1:4 ratio for label:input)
component SourceInputRow inherits Rectangle {
    in property <int> index;
    in-out property <string> path;
    in property <bool> is-reference;

    callback browse-clicked();
    callback path-changed(string);

    min-height: 32px;
    max-height: 40px;

    HorizontalBox {
        spacing: Theme.spacing-sm;
        padding-top: 2px;
        padding-bottom: 2px;

        // Label (1 unit stretch) - matches Qt layout.addWidget(label, 1)
        Text {
            text: is-reference ? "Source " + index + " (Reference):" : "Source " + index + ":";
            font-size: Theme.font-md;
            color: Theme.text-primary;
            vertical-alignment: center;
            horizontal-stretch: 1;
            min-width: 140px;
        }

        // Path input with drop support (4 units stretch) - matches Qt layout.addWidget(line_edit, 4)
        DropArea {
            horizontal-stretch: 4;

            dropped(event) => {
                if (event.mime-type == "text/uri-list") {
                    root.path-changed(event.data);
                }
            }

            LineEdit {
                text <=> root.path;
                placeholder-text: "Drop file here or click Browse...";

                edited => {
                    root.path-changed(root.path);
                }
            }
        }

        // Browse button (fixed width) - matches Qt layout.addWidget(browse_btn)
        Button {
            text: "Browseâ€¦";
            clicked => { root.browse-clicked(); }
        }
    }
}

export component AddJobDialog inherits Window {
    title: "Add Job(s) to Queue";
    min-width: 700px;
    min-height: 300px;
    preferred-width: 750px;
    preferred-height: 350px;
    default-font-size: 13px;

    // Dialog state
    in-out property <[SourceInputData]> sources: [
        { index: 1, path: "", is-reference: true },
        { index: 2, path: "", is-reference: false },
    ];
    in-out property <string> error-message: "";
    in-out property <bool> is-processing: false;

    // Result - set by Rust when jobs are discovered
    out property <bool> accepted: false;

    // Callbacks for Rust logic
    callback add-source();
    callback browse-source(int);  // source index
    callback source-path-changed(int, string);  // source index, new path
    callback find-and-add-jobs();
    callback cancel();

    VerticalBox {
        padding: Theme.padding-lg;
        spacing: Theme.spacing-md;

        // Scrollable source inputs area (main content)
        ScrollView {
            vertical-stretch: 1;

            VerticalBox {
                spacing: Theme.spacing-xs;
                padding: Theme.padding-xs;

                for source[idx] in sources: SourceInputRow {
                    index: source.index;
                    path: source.path;
                    is-reference: source.is-reference;

                    browse-clicked => { root.browse-source(source.index); }
                    path-changed(p) => { root.source-path-changed(source.index, p); }
                }
            }
        }

        // Add source button - matches Qt layout
        Button {
            text: "Add Another Source";
            enabled: sources.length < 10;
            clicked => { root.add-source(); }
        }

        // Error message (if any) - subtle styling
        if error-message != "": Rectangle {
            background: #3a2020;
            border-radius: Theme.radius-sm;
            max-height: 40px;

            HorizontalBox {
                padding: Theme.padding-sm;

                Text {
                    text: error-message;
                    color: #ff6666;
                    font-size: Theme.font-sm;
                    wrap: word-wrap;
                    vertical-alignment: center;
                }
            }
        }

        // Dialog buttons - matches QDialogButtonBox(Ok | Cancel) layout
        HorizontalBox {
            alignment: end;
            spacing: Theme.spacing-sm;

            Button {
                text: is-processing ? "Discovering..." : "Find & Add Jobs";
                enabled: !is-processing;
                clicked => { root.find-and-add-jobs(); }
            }

            Button {
                text: "Cancel";
                enabled: !is-processing;
                clicked => { root.cancel(); }
            }
        }
    }
}
