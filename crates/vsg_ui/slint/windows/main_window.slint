import { VerticalBox, HorizontalBox, Button, TextEdit, GroupBox, CheckBox, ProgressIndicator } from "std-widgets.slint";
import { SourceInput } from "../components/source_input.slint";

export component MainWindow inherits Window {
    title: "Video/Audio Sync & Merge";
    min-width: 800px;
    min-height: 500px;
    preferred-width: 1000px;
    preferred-height: 600px;
    default-font-size: 14px;

    // Properties that Rust can read/write
    in-out property <string> log-text: "";
    in-out property <string> status-text: "Ready";
    in-out property <float> progress-value: 0;
    in-out property <bool> archive-logs: true;

    // Source paths (only 3 inputs, Source 4 is results-only)
    in-out property <string> source1-path: "";
    in-out property <string> source2-path: "";
    in-out property <string> source3-path: "";

    // Latest job results (delays in ms, empty string = not calculated)
    in-out property <string> delay-source2: "";
    in-out property <string> delay-source3: "";
    in-out property <string> delay-source4: "";

    // Callbacks that Rust can handle
    callback settings-clicked();
    callback queue-jobs-clicked();
    callback browse-source1();
    callback browse-source2();
    callback browse-source3();
    callback analyze-only-clicked();
    callback source-path-changed(int, string);  // source index (1-3), new path

    VerticalBox {
        padding: 8px;
        spacing: 4px;

        // Settings button (top left)
        HorizontalLayout {
            alignment: start;
            Button {
                text: "Settings...";
                clicked => { settings-clicked(); }
            }
        }

        // Main Workflow Section
        GroupBox {
            title: "Main Workflow";

            VerticalBox {
                padding: 6px;
                spacing: 4px;

                Button {
                    text: "Open Job Queue for Merging...";
                    horizontal-stretch: 1;
                    clicked => { queue-jobs-clicked(); }
                }

                CheckBox {
                    text: "Archive logs to a zip file on batch completion";
                    checked <=> archive-logs;
                }
            }
        }

        // Quick Analysis Section
        GroupBox {
            title: "Quick Analysis (Analyze Only)";

            VerticalBox {
                padding: 6px;
                spacing: 4px;

                // Source 1 (Reference)
                SourceInput {
                    label: "Source 1 (Reference):";
                    path <=> source1-path;
                    placeholder: "Drop video file here or browse...";
                    browse-clicked => { browse-source1(); }
                    path-changed(p) => { source-path-changed(1, p); }
                }

                // Source 2
                SourceInput {
                    label: "Source 2:";
                    path <=> source2-path;
                    placeholder: "Drop video file here or browse...";
                    browse-clicked => { browse-source2(); }
                    path-changed(p) => { source-path-changed(2, p); }
                }

                // Source 3
                SourceInput {
                    label: "Source 3:";
                    path <=> source3-path;
                    placeholder: "Drop video file here or browse...";
                    browse-clicked => { browse-source3(); }
                    path-changed(p) => { source-path-changed(3, p); }
                }

                // Analyze Only button (right-aligned)
                HorizontalLayout {
                    alignment: end;
                    Button {
                        text: "Analyze Only";
                        clicked => { analyze-only-clicked(); }
                    }
                }
            }
        }

        // Status Bar
        HorizontalLayout {
            spacing: 8px;
            alignment: stretch;

            Text {
                text: "Status: " + status-text;
                vertical-alignment: center;
            }

            ProgressIndicator {
                progress: progress-value / 100;
                horizontal-stretch: 1;
                min-height: 16px;
            }
        }

        // Latest Job Results
        GroupBox {
            title: "Latest Job Results";

            HorizontalLayout {
                padding: 4px;
                spacing: 16px;

                Text {
                    text: "Source 2 Delay:";
                    vertical-alignment: center;
                }
                Text {
                    text: delay-source2 == "" ? "—" : delay-source2;
                    vertical-alignment: center;
                }

                Text {
                    text: "Source 3 Delay:";
                    vertical-alignment: center;
                }
                Text {
                    text: delay-source3 == "" ? "—" : delay-source3;
                    vertical-alignment: center;
                }

                Text {
                    text: "Source 4 Delay:";
                    vertical-alignment: center;
                }
                Text {
                    text: delay-source4 == "" ? "—" : delay-source4;
                    vertical-alignment: center;
                }

                // Stretch to push results to the left
                Rectangle {
                    horizontal-stretch: 1;
                }
            }
        }

        // Log Section - should expand to fill remaining space
        GroupBox {
            title: "Log";
            vertical-stretch: 3;
            min-height: 200px;

            TextEdit {
                text <=> log-text;
                read-only: true;
                horizontal-stretch: 1;
                vertical-stretch: 1;
            }
        }
    }
}
